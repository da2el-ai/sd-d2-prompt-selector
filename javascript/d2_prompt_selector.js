var y=Object.defineProperty;var f=(c,t,e)=>t in c?y(c,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):c[t]=e;var s=(c,t,e)=>(f(c,typeof t!="symbol"?t+"":t,e),e);const _=c=>{const t={___:[]};function e(n){if(Array.isArray(n)){t.___.push(...n);return}Object.keys(n).forEach(i=>{const a=n[i];if(typeof a=="string"){t[i]=a;return}e(a)})}return e(c),t},m=(c,t)=>{const e={};return c.___.filter(n=>n.includes(t)).forEach(n=>{e[n]=n}),Object.keys(c).forEach(n=>{if(n==="___")return;const i=c[n];(n.includes(t)||i.includes(t))&&(e[n]=i)}),e},h=class h{constructor(){s(this,"container");s(this,"input")}static setTags(t){h.convedTags=_(t)}createSearchContainer(t){const e=opts.d2_ps_enable_realtime_search;return this.input=r.searchInput(),this.input.addEventListener("keydown",n=>{var i;(e||n.key==="Enter"||n.key==="NumpadEnter")&&t(m(h.convedTags,((i=this.input)==null?void 0:i.value)||""))}),this.container=r.searchContainer(this.input,{onClick:()=>{var n;t(m(h.convedTags,((n=this.input)==null?void 0:n.value)||""))}}),this.container}};s(h,"ICON","🔍"),s(h,"convedTags",{___:[]});let p=h;class r{static baseButton(t,{size:e="sm",color:n="primary"}){const i=document.createElement("button");return i.classList.add(`gr-button-${e}`,`gr-button-${n}`,e,n),i.textContent=t,i}static openButton({onClick:t=()=>{}}){const e=r.baseButton("🔯タグを選択",{size:"sm",color:"secondary"});return e.classList.add("d2ps-button","d2ps-button--open"),e.addEventListener("click",t),e}static psContainer(t=""){const e=document.createElement("div");return e.id=t,e.classList.add("d2ps-ps-container","tabs","gradio-tabs"),e}static negativeCheckbox(t,{onChange:e}){const n=document.createElement("input");n.setAttribute("type","checkbox"),n.classList.add("d2ps-checkbox"),n.addEventListener("change",()=>{e(n.checked)});const i=document.createElement("span");i.classList.add("d2ps-label__text"),i.textContent=t;const a=document.createElement("label");return a.classList.add("d2ps-label"),a.appendChild(n),a.appendChild(i),a}static tabContainer(){const t=document.createElement("div");return t.classList.add("d2ps-tab-nav","tab-nav"),t}static tabButton(t,{onClick:e=()=>{}}){const n=r.baseButton(t,{});return n.addEventListener("click",e),n.classList.add("d2ps-tab-button"),n}static tagField(){const t=document.createElement("div");return t.classList.add("d2ps-tag-field"),t}static tagButton(t,{onClick:e=()=>{},onRightClick:n=()=>{},onMouseEnter:i=()=>{},onMouseLeave:a=()=>{},color:o="primary"}){const d=r.baseButton(t,{color:o});return d.classList.add("d2ps-button","d2ps-button--tag"),d.addEventListener("click",e),d.addEventListener("contextmenu",n),d.addEventListener("mouseenter",i),d.addEventListener("mouseleave",a),d}static randomButton(t,{onClick:e=()=>{},onRightClick:n=()=>{},color:i="primary"}){const a=r.baseButton(t,{color:i});return a.classList.add("d2ps-button","d2ps-button--random"),a.addEventListener("click",e),a.addEventListener("contextmenu",n),a}static toolTipContainer(){const t=document.createElement("div");return t.classList.add("d2ps-tooltip-container"),t}static searchContainer(t,{onClick:e=()=>{}}){const n=document.createElement("div");n.classList.add("d2ps-search-container"),n.appendChild(t);const i=r.baseButton(`${p.ICON}検索`,{size:"sm",color:"secondary"});return i.classList.add("d2ps-button"),i.addEventListener("click",e),n.appendChild(i),n}static searchInput(){const t=document.createElement("input");return t.classList.add("d2ps-search-input"),t}}class ${constructor(t,e){s(this,"button");s(this,"id");this.id=t,this.button=r.tabButton(t,{onClick:()=>{e(this.id)}})}setActive(t){this.button.setAttribute("data-active",t?"true":"false")}}class E{constructor(t){s(this,"tabButtons");s(this,"activeCategory");s(this,"onChange");this.onChange=t,this.tabButtons=[],this.activeCategory=""}createTabNavi(t,e){const n=Object.keys(e),i=Array.from(new Set([...t.sort,...n])),a=r.tabContainer();return i.push(p.ICON),i.forEach(o=>{if(o!==p.ICON&&!e.hasOwnProperty(o))return;const d=new $(o,()=>{this.$_clickTabButton(o)});this.tabButtons.push(d),a.appendChild(d.button)}),this.$_clickTabButton(i[0]),a}$_clickTabButton(t){this.activeCategory=t,this.tabButtons.forEach(e=>{e.setActive(e.id===t)}),this.onChange()}}const l=class l{static init(){const t=l;document.querySelector(t.CONTAINER_CLASS)||(t.container=r.toolTipContainer(),t.container.addEventListener("animationend",()=>{t.container.setAttribute("data-show","")}),document.body.appendChild(t.container))}static get isEnabled(){return opts.d2_ps_enable_tooltip}static showTip(t){const e=l;e.isEnabled&&(e.toHide=!1,e.container.textContent=t,e.container.setAttribute("data-show","true"))}static hideTip(){const t=l;t.isEnabled&&(t.toHide=!0,setTimeout(()=>{t.toHide&&t.container.setAttribute("data-show","false")},500))}};s(l,"CONTAINER_CLASS","d2ps-tooltip-container"),s(l,"container"),s(l,"toHide",!1);let g=l;class C{constructor(t,e,n){s(this,"onClick");s(this,"onRightClick");s(this,"categoryId","");s(this,"container");this.categoryId=t,this.onClick=e,this.onRightClick=n,this.container=r.tagField(),this.container.style.display="none"}createSearch(){this.container.classList.add("d2ps-tag-field--with-random");const e=new p().createSearchContainer(n=>{const i=this.container.children;i.length>=2&&i[1].remove();const a=r.tagField();this.container.appendChild(a),this.$_createButtons(n,"").forEach(o=>{a.appendChild(o)})});return this.container.appendChild(e),this.container}createCategory(t){return this.$_createButtons(t,this.categoryId).forEach(e=>{this.container.appendChild(e)}),this.container}$_createButtons(t,e=""){return Array.isArray(t)?t.map(n=>this.$_createTagButton("tag",n,n,"secondary")):Object.keys(t).map(n=>{const i=t[n],a=`${e}:${n}`;if(typeof i=="string")return this.$_createTagButton("tag",n,i,"secondary");const o=r.tagField();o.classList.add("d2ps-tag-field--with-random"),o.appendChild(this.$_createTagButton("random",n,`@${a}@`));const d=r.tagField();return o.appendChild(d),this.$_createButtons(i,a).forEach(u=>{d.appendChild(u)}),o})}$_createTagButton(t,e,n,i="primary"){const a={onClick:o=>{o.preventDefault(),this.onClick(n,o.metaKey||o.ctrlKey)},onRightClick:o=>{o.preventDefault(),this.onRightClick(n,o.metaKey||o.ctrlKey)},onMouseEnter:()=>{g.showTip(n)},onMouseLeave:()=>{g.hideTip()},color:i};return t==="random"?r.randomButton(e,a):r.tagButton(e,a)}}class v{constructor(t="txt2img"){s(this,"AREA_ID_BASE","d2-prompt-selector-");s(this,"type");s(this,"visible");s(this,"toNegative");s(this,"tags");s(this,"config");s(this,"categories");s(this,"tabNavi");this.type=t,this.visible=!1,this.toNegative=!1,this.tags={},this.categories=[]}createControl(t){const e=r.openButton({onClick:()=>{this.changeVisible()}}),n=gradioApp().getElementById(`d2_ps_reload_button_${this.type}`);n.addEventListener("click",async()=>{await t()});const i=gradioApp().getElementById(`${this.type}_actions_column`),a=document.createElement("div");a.classList.add("d2ps-action-container"),a.appendChild(e),a.appendChild(n),i.appendChild(a)}init(t,e){this.tags=t,this.config=e;const n=this.$_getContainer();n!=null&&(n.remove(),this.categories=[]),gradioApp().getElementById(`${this.type}_toprow`).after(this.$_render())}changeVisible(){this.visible=!this.visible,this.$_getContainer().style.display=this.visible?"block":"none"}$_getContainer(){return gradioApp().querySelector(`#${this.AREA_ID_BASE}${this.type}`)}$_render(){const t=r.psContainer(`${this.AREA_ID_BASE}${this.type}`),e=r.negativeCheckbox("ネガティブプロンプトに入力（Ctrl/Command + クリックでも可）",{onChange:n=>{this.toNegative=n}});return t.appendChild(e),t.appendChild(this.$_renderTabNavi()),this.$_renderCategory(t),this.$_changeCategory(),t}$_renderTabNavi(){return this.tabNavi=new E(()=>{this.$_changeCategory()}),this.tabNavi.createTabNavi(this.config,this.tags)}$_changeCategory(){this.categories.forEach(t=>{this.tabNavi.activeCategory===t.categoryId?t.container.style.display="flex":t.container.style.display="none"})}$_renderCategory(t){Object.keys(this.tags).forEach(i=>{const a=new C(i,(d,u=!1)=>{this.$_addTag(d,u)},(d,u=!1)=>{this.$_removeTag(d,u)}),o=a.createCategory(this.tags[i]);t.appendChild(o),this.categories.push(a)});const e=new C("🔍",(i,a=!1)=>{this.$_addTag(i,a)},(i,a=!1)=>{this.$_removeTag(i,a)}),n=e.createSearch();t.appendChild(n),this.categories.push(e)}$_addTag(t,e=!1){const n=e||this.toNegative?`${this.type}_neg_prompt`:`${this.type}_prompt`,i=gradioApp().getElementById(n).querySelector("textarea");i.value.trim()===""?i.value=t:i.value.trim().endsWith(",")?i.value+=" "+t:i.value+=", "+t,updateInput(i)}$_removeTag(t,e=!1){const n=e||this.toNegative?`${this.type}_neg_prompt`:`${this.type}_prompt`,i=gradioApp().getElementById(n).querySelector("textarea");if(i.value.trimStart().startsWith(t)){const a=i.value.match(new RegExp(`${t.replace(/[-\/\\^$*+?.()|\[\]{}]/g,"\\$&")},*`));i.value=i.value.replace(a[0],"").trimStart()}else i.value=i.value.replace(`, ${t}`,"");updateInput(i)}}class L{constructor(){s(this,"tags");s(this,"config");s(this,"t2iPromptSelector");s(this,"i2iPromptSelector");this.t2iPromptSelector=new v("txt2img"),this.i2iPromptSelector=new v("img2img"),this.tags={}}createControl(){this.t2iPromptSelector.createControl(()=>{this.init()}),this.i2iPromptSelector.createControl(()=>{this.init()})}async init(){await this.getTags(),this.t2iPromptSelector.init(this.tags,this.config),this.i2iPromptSelector.init(this.tags,this.config)}changeVisible(){this.t2iPromptSelector.changeVisible(),this.i2iPromptSelector.changeVisible()}async getTags(){const e=await(await fetch(`/d2ps/tags?${new Date().getTime()}`)).json();this.config=e.__config__,delete e.__config__,this.tags=e,p.setTags(e)}}const b=new L;onOptionsChanged(()=>{b.init()});onUiLoaded(()=>{b.createControl(),b.init(),g.init()});
