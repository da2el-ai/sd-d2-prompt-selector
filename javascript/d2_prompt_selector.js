var g=Object.defineProperty;var u=(c,t,e)=>t in c?g(c,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):c[t]=e;var s=(c,t,e)=>(u(c,typeof t!="symbol"?t+"":t,e),e);class r{static baseButton(t,{size:e="sm",color:a="primary"}){const n=document.createElement("button");return n.classList.add(`gr-button-${e}`,`gr-button-${a}`,e,a),n.textContent=t,n}static openButton({onClick:t=()=>{}}){const e=r.baseButton("🔯タグを選択",{size:"sm",color:"secondary"});return e.classList.add("d2ps-button","d2ps-button--open"),e.addEventListener("click",t),e}static psContainer(t=""){const e=document.createElement("div");return e.id=t,e.classList.add("d2ps-ps-container","tabs","gradio-tabs"),e}static negativeCheckbox(t,{onChange:e}){const a=document.createElement("input");a.setAttribute("type","checkbox"),a.classList.add("d2ps-checkbox"),a.addEventListener("change",()=>{e(a.checked)});const n=document.createElement("span");n.classList.add("d2ps-label__text"),n.textContent=t;const i=document.createElement("label");return i.classList.add("d2ps-label"),i.appendChild(a),i.appendChild(n),i}static tabContainer(){const t=document.createElement("div");return t.classList.add("d2ps-tab-nav","tab-nav"),t}static tabButton(t,{onClick:e=()=>{}}){const a=r.baseButton(t,{});return a.addEventListener("click",e),a.classList.add("d2ps-tab-button"),a}static tagField(){const t=document.createElement("div");return t.classList.add("d2ps-tag-field"),t}static tagButton(t,{onClick:e=()=>{},onRightClick:a=()=>{},color:n="primary"}){const i=r.baseButton(t,{color:n});return i.classList.add("d2ps-button","d2ps-button--tag"),i.addEventListener("click",e),i.addEventListener("contextmenu",a),i}static randomButton(t,{onClick:e=()=>{},onRightClick:a=()=>{},color:n="primary"}){const i=r.baseButton(t,{color:n});return i.classList.add("d2ps-button","d2ps-button--random"),i.addEventListener("click",e),i.addEventListener("contextmenu",a),i}}class b{constructor(t,e){s(this,"button");s(this,"id");this.id=t,this.button=r.tabButton(t,{onClick:()=>{e(this.id)}})}setActive(t){this.button.setAttribute("data-active",t?"true":"false")}}class m{constructor(t){s(this,"tabButtons");s(this,"activeCategory");s(this,"onChange");this.onChange=t,this.tabButtons=[],this.activeCategory=""}createTabNavi(t,e){const a=Object.keys(e),n=Array.from(new Set([...t.sort,...a])),i=r.tabContainer();return n.forEach(o=>{const d=new b(o,()=>{this.$_clickTabButton(o)});this.tabButtons.push(d),i.appendChild(d.button)}),this.$_clickTabButton(n[0]),i}$_clickTabButton(t){this.activeCategory=t,this.tabButtons.forEach(e=>{e.setActive(e.id===t)}),this.onChange()}}class y{constructor(t,e,a){s(this,"onClick");s(this,"onRightClick");s(this,"categoryId","");s(this,"container");this.categoryId=t,this.onClick=e,this.onRightClick=a,this.container=r.tagField(),this.container.style.display="none"}createCategory(t){return this.$_createButtons(t,this.categoryId).forEach(e=>{this.container.appendChild(e)}),this.container}$_createButtons(t,e=""){return Array.isArray(t)?t.map(a=>this.$_createTagButton("tag",a,a,"secondary")):Object.keys(t).map(a=>{const n=t[a],i=`${e}:${a}`;if(typeof n=="string")return this.$_createTagButton("tag",a,n,"secondary");const o=r.tagField();o.classList.add("d2ps-tag-field--with-random"),o.appendChild(this.$_createTagButton("random",a,`@${i}@`));const d=r.tagField();return o.appendChild(d),this.$_createButtons(n,i).forEach(p=>{d.appendChild(p)}),o})}$_createTagButton(t,e,a,n="primary"){const i={onClick:o=>{o.preventDefault(),this.onClick(a,o.metaKey||o.ctrlKey)},onRightClick:o=>{o.preventDefault(),this.onRightClick(a,o.metaKey||o.ctrlKey)},color:n};return t==="random"?r.randomButton(e,i):r.tagButton(e,i)}}class h{constructor(t="txt2img"){s(this,"AREA_ID_BASE","d2-prompt-selector-");s(this,"type");s(this,"visible");s(this,"toNegative");s(this,"tags");s(this,"config");s(this,"categories");s(this,"tabNavi");this.type=t,this.visible=!1,this.toNegative=!1,this.tags={},this.categories=[]}createControl(t){const e=r.openButton({onClick:()=>{this.changeVisible()}}),a=gradioApp().getElementById(`d2_ps_reload_button_${this.type}`);a.addEventListener("click",async()=>{await t()});const n=gradioApp().getElementById(`${this.type}_actions_column`),i=document.createElement("div");i.classList.add("d2ps-action-container"),i.appendChild(e),i.appendChild(a),n.appendChild(i)}init(t,e){this.tags=t,this.config=e;const a=this.$_getContainer();a!=null&&(a.remove(),this.categories=[]),gradioApp().getElementById(`${this.type}_toprow`).after(this.$_render())}changeVisible(){this.visible=!this.visible,this.$_getContainer().style.display=this.visible?"block":"none"}$_getContainer(){return gradioApp().querySelector(`#${this.AREA_ID_BASE}${this.type}`)}$_render(){const t=r.psContainer(`${this.AREA_ID_BASE}${this.type}`),e=r.negativeCheckbox("ネガティブプロンプトに入力（Ctrl/Command + クリックでも可）",{onChange:a=>{this.toNegative=a}});return t.appendChild(e),t.appendChild(this.$_renderTabNavi()),this.$_renderCategory(t),this.$_changeCategory(),t}$_renderTabNavi(){return this.tabNavi=new m(()=>{this.$_changeCategory()}),this.tabNavi.createTabNavi(this.config,this.tags)}$_changeCategory(){this.categories.forEach(t=>{this.tabNavi.activeCategory===t.categoryId?t.container.style.display="flex":t.container.style.display="none"})}$_renderCategory(t){Object.keys(this.tags).forEach(e=>{const a=new y(e,(i,o=!1)=>{this.$_addTag(i,o)},(i,o=!1)=>{this.$_removeTag(i,o)}),n=a.createCategory(this.tags[e]);t.appendChild(n),this.categories.push(a)})}$_addTag(t,e=!1){const a=e||this.toNegative?`${this.type}_neg_prompt`:`${this.type}_prompt`,n=gradioApp().getElementById(a).querySelector("textarea");n.value.trim()===""?n.value=t:n.value.trim().endsWith(",")?n.value+=" "+t:n.value+=", "+t,updateInput(n)}$_removeTag(t,e=!1){const a=e||this.toNegative?`${this.type}_neg_prompt`:`${this.type}_prompt`,n=gradioApp().getElementById(a).querySelector("textarea");if(n.value.trimStart().startsWith(t)){const i=n.value.match(new RegExp(`${t.replace(/[-\/\\^$*+?.()|\[\]{}]/g,"\\$&")},*`));n.value=n.value.replace(i[0],"").trimStart()}else n.value=n.value.replace(`, ${t}`,"");updateInput(n)}}class C{constructor(){s(this,"tags");s(this,"config");s(this,"t2iPromptSelector");s(this,"i2iPromptSelector");this.t2iPromptSelector=new h("txt2img"),this.i2iPromptSelector=new h("img2img"),this.tags={}}createControl(){this.t2iPromptSelector.createControl(async()=>{await this.getTags()}),this.i2iPromptSelector.createControl(async()=>{await this.getTags()})}async init(){await this.getTags(),this.t2iPromptSelector.init(this.tags,this.config),this.i2iPromptSelector.init(this.tags,this.config)}changeVisible(){this.t2iPromptSelector.changeVisible(),this.i2iPromptSelector.changeVisible()}async getTags(){const e=await(await fetch(`/d2ps/tags?${new Date().getTime()}`)).json();this.config=e.__config__,delete e.__config__,this.tags=e}}const l=new C;onOptionsChanged(()=>{l.init()});onUiLoaded(()=>{l.createControl(),l.init()});
